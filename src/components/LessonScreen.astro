---
// Lesson screen component for English learning app
import { marked } from 'marked';
import type { ItemType, TableData, TitleData, ParagraphData, CodeData, ListData, SeparatorData, TextPart } from '../data/lessons';

// Configure marked options
marked.setOptions({
  breaks: true,
  gfm: true
});

// Functions to process markdown
function processMarkdown(text: string): string {
  return marked.parse(text, { async: false }) as string;
}

function processInlineMarkdown(text: string): string {
  return marked.parseInline(text, { async: false }) as string;
}

// Helper function to render TextPart
function renderTextPart(part: TextPart): string {
  let result = part.text;
  if (part.bold) result = `<strong class="font-semibold">${result}</strong>`;
  if (part.italic) result = `<em class="italic">${result}</em>`;
  if (part.code) result = `<code class="px-1.5 py-0.5 bg-indigo-100 dark:bg-indigo-900/50 rounded text-sm font-mono text-indigo-800 dark:text-indigo-200 border border-indigo-200 dark:border-indigo-800">${result}</code>`;
  if (part.emoji) result = `${part.emoji} ${result}`;
  return result;
}

// Helper function to render example items
function renderItemType(item: ItemType): string {
  if (typeof item === 'string') {
    return processMarkdown(item);
  }
  
  switch (item.type) {
    case 'table':
      return renderTable(item as TableData);
    case 'title':
      return renderTitle(item as TitleData);
    case 'paragraph':
      return renderParagraph(item as ParagraphData);
    case 'code':
      return renderCode(item as CodeData);
    case 'list':
      return renderList(item as ListData);
    case 'separator':
      return renderSeparator(item as SeparatorData);
    default:
      return '';
  }
}

function renderTable(data: TableData): string {
  const alignments = data.alignments || data.headers.map(() => 'left');
  const headerRow = data.headers.map((header, i) => 
    `<th class="px-4 py-3 text-sm font-semibold text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 border-b-2 border-gray-300 dark:border-gray-600 first:rounded-tl-lg last:rounded-tr-lg" style="text-align: ${alignments[i]}">${processInlineMarkdown(header)}</th>`
  ).join('');
  
  const rows = data.rows.map((row, rowIndex) => {
    const isLastRow = rowIndex === data.rows.length - 1;
    return `<tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors ${isLastRow ? 'last:border-b-0' : ''}">${row.map((cell, i) => 
      `<td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300" style="text-align: ${alignments[i]}">${processInlineMarkdown(cell)}</td>`
    ).join('')}</tr>`;
  }).join('');
  
  return `<div class="overflow-x-auto my-4 rounded-lg border border-gray-300 dark:border-gray-600 shadow-modern"><table class="min-w-full border-collapse"><thead><tr>${headerRow}</tr></thead><tbody>${rows}</tbody></table></div>`;
}

function renderTitle(data: TitleData): string {
  const level = data.level || 3;
  const emoji = data.emoji ? `${data.emoji} ` : '';
  const headingTag = `h${level}`;
  const classes = {
    1: 'text-2xl md:text-3xl font-bold mb-4 mt-6 text-indigo-700 dark:text-indigo-300',
    2: 'text-xl md:text-2xl font-bold mb-3 mt-5 text-indigo-700 dark:text-indigo-300',
    3: 'text-lg md:text-xl font-bold mb-3 mt-4 text-indigo-600 dark:text-indigo-400',
    4: 'text-base md:text-lg font-semibold mb-2 mt-3 text-indigo-600 dark:text-indigo-400',
    5: 'text-sm md:text-base font-semibold mb-2 mt-2 text-indigo-600 dark:text-indigo-400',
    6: 'text-sm font-semibold mb-1 mt-2 text-indigo-600 dark:text-indigo-400'
  };
  
  return `<${headingTag} class="${classes[level]}">${emoji}${processInlineMarkdown(data.text)}</${headingTag}>`;
}

function renderParagraph(data: ParagraphData): string {
  const content = data.content.map(part => renderTextPart(part)).join('');
  return `<p class="text-gray-700 dark:text-gray-300 leading-relaxed mb-3">${content}</p>`;
}

function renderCode(data: CodeData): string {
  if (data.inline) {
    return `<code class="px-2 py-1 bg-indigo-100 dark:bg-indigo-900/50 rounded text-sm font-mono text-indigo-800 dark:text-indigo-200 border border-indigo-200 dark:border-indigo-800">${data.code}</code>`;
  }
  const language = data.language || '';
  return `<pre class="bg-gray-900 dark:bg-gray-950 rounded-lg p-4 overflow-x-auto my-4 border border-gray-700 dark:border-gray-800 shadow-modern"><code class="text-gray-100 font-mono text-sm ${language ? `language-${language}` : ''}">${data.code}</code></pre>`;
}

function renderList(data: ListData): string {
  const items = data.items.map(item => {
    const content = item.map(part => renderTextPart(part)).join('');
    return `<li class="text-gray-700 dark:text-gray-300 leading-relaxed mb-2 ml-4">${content}</li>`;
  }).join('');
  
  const tag = data.ordered ? 'ol' : 'ul';
  const listClass = data.ordered ? 'list-decimal' : 'list-disc';
  return `<${tag} class="${listClass} space-y-2 my-3">${items}</${tag}>`;
}

function renderSeparator(data: SeparatorData): string {
  return `<hr class="my-6 border-gray-300 dark:border-gray-600 border-t-2" />`;
}

export interface Props {
  title: string;
  description: string;
  learningPoints: string[];
  content: {
    topic: string;
    explanation: string;
    examples?: ItemType[];
  }[];
  quiz: {
    question: string;
    options: string[];
    correctAnswer: number;
    explanation?: string;
  }[];
}

const { title, description, learningPoints, content, quiz } = Astro.props;

---
<!-- Google AdSense Script -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6926927753782454"
     crossorigin="anonymous"></script>

<!-- Anuncio vertical fijo a la izquierda -->
<div class="ad-container-left">
  <ins class="adsbygoogle"
       style="display:inline-block;width:160px;height:600px"
       data-ad-client="ca-pub-6926927753782454"
       data-ad-slot="5203566698"
       data-ad-format="vertical"></ins>
  <script is:inline>
     (window.adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<div class="lesson-screen bg-white dark:bg-gray-800 rounded-2xl shadow-modern-xl border border-gray-200 dark:border-gray-700 p-8 md:p-10 max-w-5xl mx-auto animate-scale-in">
  <!-- Lesson Header -->
  <header class="mb-10 pb-8 border-b border-gray-200/50 dark:border-gray-700/50">
    <div class="flex items-start space-x-4 mb-4">
      <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-2xl shadow-lg">
        üìö
      </div>
      <div class="flex-1">
        <h1
          class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4 leading-tight"
          set:html={processInlineMarkdown(title)}
        />
        <div
          class="text-lg md:text-xl text-gray-600 dark:text-gray-300 leading-relaxed space-y-3"
          set:html={processMarkdown(description)}
        />
      </div>
    </div>
  </header>

  <!-- Learning Points -->
  <section class="mb-10">
    <div class="flex items-center space-x-3 mb-6">
      <div class="w-1 h-8 bg-gradient-to-b from-indigo-500 to-purple-600 rounded-full"></div>
      <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-200 flex items-center">
        <span class="mr-2">üéØ</span>
        What you'll learn in this lesson
      </h2>
    </div>
    <div class="grid md:grid-cols-2 gap-3">
      {learningPoints.map((point, index) => (
        <div class="flex items-start space-x-3 p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-200/50 dark:border-green-800/50 hover:shadow-modern transition-all duration-300 animate-fade-in" style={`animation-delay: ${index * 0.1}s`}>
          <div class="flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white text-sm font-bold shadow-lg mt-0.5">
            ‚úì
          </div>
          <span
            class="text-gray-700 dark:text-gray-300 flex-1"
            set:html={processInlineMarkdown(point)}
          />
        </div>
      ))}
    </div>
  </section>

  <!-- Lesson Content -->
  <section class="mb-10">
    <div class="flex items-center space-x-3 mb-8">
      <div class="w-1 h-8 bg-gradient-to-b from-blue-500 to-cyan-600 rounded-full"></div>
      <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-200 flex items-center">
        <span class="mr-2">üìö</span>
        Lesson Content
      </h2>
    </div>
    
    <div class="space-y-6">
      {content.map((section, index) => (
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 border border-gray-200 dark:border-gray-700 shadow-modern hover:shadow-modern-lg transition-all duration-300 animate-slide-in" style={`animation-delay: ${index * 0.1}s`}>
          <div class="flex items-center space-x-3 mb-4">
            <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
            <h3
              class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-200"
              set:html={processInlineMarkdown(section.topic)}
            />
          </div>
          <div
            class="text-gray-700 dark:text-gray-300 leading-relaxed mb-6 text-base md:text-lg space-y-4"
            set:html={processMarkdown(section.explanation)}
          />
          
          {section.examples && section.examples.length > 0 && (
            <div class="mt-6">
              <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3 text-lg flex items-center">
                <span class="mr-2">üí°</span>
                Examples:
              </h4>
              <div class="bg-blue-50 dark:bg-blue-900/30 rounded-xl p-5 md:p-6 border-l-4 border-indigo-500 shadow-modern">
                <div class="space-y-4">
                  {section.examples.map((example) => {
                    const renderedContent = renderItemType(example);
                    // Only wrap in list item if it's a string (backward compatibility)
                    if (typeof example === 'string') {
                      return (
                        <div class="flex items-start space-x-2">
                          <span class="text-indigo-500 dark:text-indigo-400 font-bold mt-1">‚Ä¢</span>
                          <div set:html={renderedContent} class="flex-1" />
                        </div>
                      );
                    }
                    // For structured elements, render directly
                    return (
                      <div set:html={renderedContent} />
                    );
                  })}
                </div>
              </div>
            </div>
          )}
        </div>
      ))}
    </div>
  </section>

  <!-- Quiz Section -->
  <section class="quiz-section mt-12 pt-10 border-t border-gray-200/50 dark:border-gray-700/50">
    <div class="flex items-center space-x-3 mb-8">
      <div class="w-1 h-8 bg-gradient-to-b from-purple-500 to-pink-600 rounded-full"></div>
      <h2 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-200 flex items-center">
        <span class="mr-2">üß†</span>
        Quiz Time - Test Your Knowledge!
      </h2>
    </div>
    
    <div id="quiz-container" class="space-y-6">
      {quiz.map((question, questionIndex) => (
        <div class="quiz-question bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 border border-purple-200 dark:border-purple-800 shadow-modern-lg hover:shadow-modern-xl transition-all duration-300 animate-scale-in" style={`animation-delay: ${questionIndex * 0.1}s`}>
          <div class="flex items-start space-x-4 mb-6">
            <div class="flex-shrink-0 w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-bold shadow-lg">
              {questionIndex + 1}
            </div>
            <h3
              class="text-lg md:text-xl font-bold text-gray-800 dark:text-gray-200 flex-1 pt-1.5"
              set:html={processInlineMarkdown(question.question)}
            />
          </div>
          
          <div class="options space-y-3" data-question={questionIndex} data-correct={question.correctAnswer}>
            {question.options.map((option, optionIndex) => (
              <label class="quiz-option flex items-center p-4 bg-gray-50 dark:bg-gray-700 rounded-xl border-2 border-gray-200 dark:border-gray-700 cursor-pointer shadow-modern hover:border-indigo-400 dark:hover:border-indigo-500 transition-all duration-300">
                <input 
                  type="radio" 
                  name={`question-${questionIndex}`} 
                  value={optionIndex}
                  class="mr-4 w-5 h-5 text-indigo-600 focus:ring-indigo-500 focus:ring-2 cursor-pointer"
                />
                <span
                  class="text-gray-700 dark:text-gray-300 font-medium flex-1"
                  set:html={processInlineMarkdown(option)}
                />
              </label>
            ))}
          </div>
          
          <div class="question-result mt-6 hidden animate-fade-in">
            <div class="result-feedback p-5 rounded-xl border-l-4 shadow-modern"></div>
            {question.explanation && (
              <div class="explanation mt-4 p-5 bg-gray-50 dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 shadow-modern">
                <div class="space-y-3">
                  <p class="text-sm md:text-base text-gray-700 dark:text-gray-300 font-semibold">
                    <strong class="text-indigo-600 dark:text-indigo-400">üí° Explanation:</strong>
                  </p>
                  <div
                    class="text-sm md:text-base text-gray-700 dark:text-gray-300 leading-relaxed space-y-3"
                    set:html={processMarkdown(question.explanation)}
                  />
                </div>
              </div>
            )}
          </div>
        </div>
      ))}
    </div>

    <!-- Quiz Results -->
    <div id="quiz-results" class="mt-10 hidden animate-scale-in">
      <div class="bg-green-50 dark:bg-green-900/30 rounded-2xl p-8 md:p-10 border border-green-200 dark:border-green-800 shadow-modern-xl">
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-green-400 to-emerald-600 mb-4 shadow-xl">
            <span class="text-4xl">üéâ</span>
          </div>
          <h3 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">
            Quiz Completed!
          </h3>
        </div>
        <div class="results-summary">
          <p class="text-xl md:text-2xl text-gray-700 dark:text-gray-300 mb-6 text-center">
            Your Score: <span id="score" class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-emerald-600 dark:from-green-400 dark:to-emerald-400"></span>
          </p>
          <div class="progress-bar bg-gray-200 dark:bg-gray-700 rounded-full h-5 md:h-6 mb-6 shadow-modern overflow-hidden">
            <div id="progress" class="progress-animation bg-gradient-to-r from-green-400 via-emerald-500 to-blue-500 h-full rounded-full transition-all duration-1000 shadow-lg"></div>
          </div>
          <div class="text-center">
            <button 
              id="restart-quiz" 
              class="btn-modern bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-300 shadow-modern-lg hover:shadow-modern-xl hover:scale-105 active:scale-95 focus-ring"
            >
              üîÑ Try Again
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script is:inline>
  // Quiz functionality - CSP compliant version
  (function() {
    'use strict';
    
    function Quiz() {
      this.questions = document.querySelectorAll('.quiz-question');
      this.currentQuestion = 0;
      this.score = 0;
      this.answers = [];
      this.initializeQuiz();
    }

    Quiz.prototype.initializeQuiz = function() {
      var self = this;
      // Add event listeners to all radio buttons
      var radioButtons = document.querySelectorAll('input[type="radio"]');
      radioButtons.forEach(function(radio) {
        radio.addEventListener('change', function(e) {
          self.handleAnswer(e);
        });
      });

      // Add restart functionality
      var restartBtn = document.getElementById('restart-quiz');
      if (restartBtn) {
        restartBtn.addEventListener('click', function() {
          self.restartQuiz();
        });
      }
    };

    Quiz.prototype.handleAnswer = function(event) {
      var target = event.target;
      var questionIndex = parseInt(target.name.split('-')[1]);
      var selectedAnswer = parseInt(target.value);
      var questionElement = target.closest('.quiz-question');
      
      var optionsDiv = questionElement.querySelector('.options');
      var dataCorrectFromDiv = optionsDiv ? optionsDiv.dataset.correct : null;
      var correctAnswer = parseInt(dataCorrectFromDiv || '0');
      
      // Store the answer
      this.answers[questionIndex] = selectedAnswer;
      
      // Show immediate feedback for this question
      this.showQuestionResult(questionElement, selectedAnswer === correctAnswer, correctAnswer);
      
      // Check if ALL questions are answered - count actual answered questions
      var answeredQuestions = this.answers.filter(function(answer) {
        return answer !== undefined;
      }).length;
      var totalQuestions = this.questions.length;
      
      var self = this;
      if (answeredQuestions === totalQuestions) {
        setTimeout(function() {
          self.showFinalResults();
        }, 1500);
      }
    };

    Quiz.prototype.showQuestionResult = function(questionElement, isCorrect, correctAnswer) {
      var resultDiv = questionElement.querySelector('.question-result');
      var feedbackDiv = resultDiv.querySelector('.result-feedback');
      
      // Clear previous content safely
      feedbackDiv.textContent = '';
      
      if (isCorrect) {
        feedbackDiv.className = 'result-feedback p-5 rounded-xl border-l-4 border-green-500 bg-green-50 dark:bg-green-900/30 shadow-modern';
        
        // Create elements safely instead of using innerHTML
        var paragraph = document.createElement('p');
        paragraph.className = 'text-green-800 dark:text-green-200 font-semibold';
        
        var emoji = document.createElement('span');
        emoji.className = 'text-2xl mr-2';
        emoji.textContent = '‚úÖ';
        
        var strong = document.createElement('strong');
        strong.textContent = 'Correct! Well done!';
        
        paragraph.appendChild(emoji);
        paragraph.appendChild(strong);
        feedbackDiv.appendChild(paragraph);
      } else {
        var labels = questionElement.querySelectorAll('label');
        var correctOption = labels[correctAnswer] ? labels[correctAnswer].textContent.trim() : '';
        feedbackDiv.className = 'result-feedback p-5 rounded-xl border-l-4 border-red-500 bg-red-50 dark:bg-red-900/30 shadow-modern';
        
        // Create elements safely instead of using innerHTML
        var paragraph = document.createElement('p');
        paragraph.className = 'text-red-800 dark:text-red-200 font-semibold';
        
        var emoji = document.createElement('span');
        emoji.className = 'text-2xl mr-2';
        emoji.textContent = '‚ùå';
        
        var strong = document.createElement('strong');
        strong.textContent = 'Incorrect. The correct answer is: ';
        
        var underline = document.createElement('span');
        underline.className = 'underline';
        underline.textContent = correctOption || '';
        
        paragraph.appendChild(emoji);
        paragraph.appendChild(strong);
        paragraph.appendChild(underline);
        feedbackDiv.appendChild(paragraph);
      }
      
      resultDiv.classList.remove('hidden');
      
      // Disable all options for this question
      var options = questionElement.querySelectorAll('input[type="radio"]');
      options.forEach(function(option) {
        option.disabled = true;
      });
    };

    Quiz.prototype.showFinalResults = function() {
      var self = this;
      // Calculate score
      this.score = this.answers.reduce(function(score, answer, index) {
        var questionElement = self.questions[index];
        var optionsDiv = questionElement.querySelector('.options');
        var correctAnswer = parseInt(optionsDiv ? (optionsDiv.dataset.correct || '0') : '0');
        return score + (answer === correctAnswer ? 1 : 0);
      }, 0);

      var percentage = Math.round((this.score / this.questions.length) * 100);
      
      // Update results display
      var scoreElement = document.getElementById('score');
      var progressElement = document.getElementById('progress');
      var resultsElement = document.getElementById('quiz-results');
      
      if (scoreElement) {
        scoreElement.textContent = this.score + '/' + this.questions.length + ' (' + percentage + '%)';
      }
      
      if (progressElement) {
        progressElement.style.width = percentage + '%';
      }
      
      if (resultsElement) {
        resultsElement.classList.remove('hidden');
        resultsElement.scrollIntoView({ behavior: 'smooth' });
      }
    };

    Quiz.prototype.restartQuiz = function() {
      // Reset all answers and UI
      this.answers = [];
      this.score = 0;
      
      // Hide results
      var resultsElement = document.getElementById('quiz-results');
      if (resultsElement) {
        resultsElement.classList.add('hidden');
      }
      
      var self = this;
      // Reset all questions
      this.questions.forEach(function(question) {
        var resultDiv = question.querySelector('.question-result');
        if (resultDiv) {
          resultDiv.classList.add('hidden');
        }
        
        var radioButtons = question.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(function(radio) {
          radio.checked = false;
          radio.disabled = false;
        });
      });
      
      // Scroll to quiz section
      var quizSection = document.querySelector('.quiz-section');
      if (quizSection) {
        quizSection.scrollIntoView({ behavior: 'smooth' });
      }
    };

    // Initialize quiz when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      new Quiz();
    });
  })();
</script>

<style>
  .lesson-screen {
    animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .quiz-question {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .quiz-question:hover {
    transform: translateY(-4px) scale(1.01);
  }

  .options label {
    position: relative;
    overflow: hidden;
  }

  .options label input[type="radio"]:checked + span {
    color: #6366f1;
    font-weight: 600;
  }

  .options label input[type="radio"]:checked {
    border-color: #6366f1;
    background-color: #6366f1;
  }

  .progress-bar {
    overflow: hidden;
    position: relative;
  }

  #progress {
    width: 0%;
    position: relative;
  }

  #progress::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(255, 255, 255, 0.4),
      transparent
    );
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  /* Estilos para el anuncio fijo a la izquierda */
  .ad-container-left {
    position: fixed;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1000;
    width: 160px;
    height: 600px;
    background-color: transparent;
  }

  .ad-container-left ins {
    display: inline-block !important;
    width: 160px !important;
    height: 600px !important;
  }

  /* Ocultar el anuncio en pantallas peque√±as y medianas */
  @media (max-width: 1400px) {
    .ad-container-left {
      display: none;
    }
  }

  /* Asegurar que el anuncio no interfiera con el contenido */
  @media (min-width: 1401px) {
    body {
      padding-left: 0;
    }
  }
</style>
